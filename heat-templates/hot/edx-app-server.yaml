# This template defines an Open edX application server. It is meant to
# be invoked from an OS::Heat::ResourceGroup. It creates a Nova
# instance of the defined flavor, and plugs that instance into an
# LBaaS pool. The Nova instance is ephemeral and uses no persistent
# storage.
heat_template_version: 2016-04-08

description: >
  Open edX application server

parameters:
  name:
    type: string
    description: Name of the server
  image:
    type: string
    description: >
      Image ID or name.
      Should be a distribution platform supported for Open edX.
    default: ubuntu-14.04-server-cloudimg
  flavor:
    type: string
    description: Flavor to use for app servers
    default: m1.large
  http_pool:
    type: string
    description: LBaaS HTTP pool
  http_port:
    type: number
    description: Service HTTP port number
  https_pool:
    type: string
    description: LBaaS HTTPS pool
  https_port:
    type: number
    description: Service HTTPS port number
  metadata:
    type: json
    description: Metadata injected into the virtual machine
  network:
    type: string
    description: Network used by the server
  security_group:
    type: string
    description: Security group used by the server
  key_name:
    type: string
    description: >
      SSH key name for authentication, to be injected into the server
      for the default user
  timeout:
    type: number
    description: Stack creation timeout (seconds)
    default: 900

resources:
  # server_done: Wait condition to signal that the server has completed its
  # installation.
  server_done:
    type: OS::Heat::WaitCondition
    properties:
      handle: {get_resource: server_done_handle}
      count: 1
      timeout: {get_param: timeout}

  server_done_handle:
    type: OS::Heat::WaitConditionHandle

  # common_config_part: cloud-init configuration common to all nodes
  common_config_part:
    type: OS::Heat::SoftwareConfig
    properties:
      config: { get_file: ../cloud-config/common.yaml }

  hosts_config_part:
    type: OS::Heat::SoftwareConfig
    properties:
      config: { get_file: ../cloud-config/hosts.yaml }

  # server_config_part: cloud-init configuration specific to this server
  server_config_part:
    type: OS::Heat::CloudConfig
    properties:
      cloud_config:
        merge_how: 'dict(recurse_array,no_replace)+list(append)'
        runcmd:
          - { get_attr: ['server_done_handle', 'curl_cli'] }

  # server_cloud_config: complete cloud-init configuration for this servers.
  #
  # Installs several packages needed for bootstrapping Open edX.
  # At the end of the cloud-init sequence, invokes the wait condition
  # callback to signal to the calling stack that server creation is
  # complete.
  server_cloud_config:
    type: OS::Heat::MultipartMime
    properties:
      parts:
        - config: {get_resource: common_config_part}
        - config: {get_resource: hosts_config_part}
        - config: {get_resource: server_config_part}

  # server: an application server instance
  #
  # Creates a new Nova VM with the appropriate flavor and
  # image. Injects the configured SSH key for the default user,
  # applies the cloud-init configuration, and plugs the VM into the
  # correct network using the correct security group.
  server:
    type: OS::Nova::Server
    properties:
      name: { get_param: name }
      flavor: { get_param: flavor }
      image: { get_param: image }
      key_name: { get_param: key_name }
      metadata: { get_param: metadata }
      user_data: { get_resource: server_cloud_config }
      user_data_format: RAW
      networks: [ { network: { get_param: network } } ]
      security_groups: [ { get_param: security_group } ]

  # http(s)_member: Neutron LBaaS v2 pool membership
  #
  # Retrieves the primary IP address from the previously created server, and
  # plugs it into the http and https load balancer pools.
  http_member:
    type: OS::Neutron::LBaaS::PoolMember
    properties:
      address: { get_attr: [ server, first_address ] }
      pool: { get_param: http_pool }
      protocol_port: { get_param: http_port }

  https_member:
    type: OS::Neutron::LBaaS::PoolMember
    properties:
      address: { get_attr: [ server, first_address ] }
      pool: { get_param: https_pool }
      protocol_port: { get_param: https_port }

outputs:
  OS::stack_id:
    value: { get_resource: server }
  server_ip:
    description: "Server's private IP address"
    value: { get_attr: [ server, first_address ] }
  http_member:
    description: Load balancer member details
    value: { get_attr: [ http_member, show ] }
  https_member:
    description: Load balancer member details
    value: { get_attr: [ https_member, show ] }
