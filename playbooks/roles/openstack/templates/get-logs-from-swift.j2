#!/bin/bash
#
#  This script can be called from cron to sync logs from swift.
#

usage() {

  cat<<EOF

  A wrapper of python-swiftclient that will sync log files from
  a swift container.

  Usage: $PROG
            -v    add verbosity (set -x)
            -n    echo what will be done
            -h    this
            -d    directory to sync to
            -b    bucket to sync from
            -p    name prefix
EOF
}

while getopts "vhnb:d:p:" opt; do
  case $opt in
    v)
      set -x
      shift
      ;;
    h)
      usage
      exit 0
      ;;
    n)
      noop="echo Would have run: "
      shift
      ;;
    d)
      directory=$OPTARG
      ;;
    b)
      container=$OPTARG
      ;;
    p)
      prefix=$OPTARG
      ;;
  esac
done

if [[ -z $container || -z $directory ]]; then
  echo "ERROR: You must provide a container and an output directory."
  usage
  exit 1
fi

set -e

# Source openstack credentials
source "{{ openstack_log_sync_script_environment }}"

# Sync the logs
$noop swift download \
  --skip-identical \
  --prefix "${prefix}" \
  --remove-prefix \
  --output-dir "${directory}" \
  $container
